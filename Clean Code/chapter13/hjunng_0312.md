## 1️⃣ **동시성이란 무엇이며, 왜 필요한가?**

### **동시성이란?**

- 동시성(Concurrency)은 **하나의 프로그램에서 여러 작업을 동시에 실행하는 것**을 의미한다.
- 여러 스레드(Thread)를 동시에 실행하는 방식으로 구현되며, CPU 자원을 효율적으로 사용하도록 도와준다.
- 동시성은 결합(Coupling)을 줄이는 전략으로, 프로그램에서 **"무엇(what)"과 "언제(when)"를 분리**하는 데 도움을 준다.

### **동시성이 필요한 이유**

1. **구조적 개선**
    - 동시성을 적용하면 프로그램이 거대한 루프 하나가 아닌, **작은 독립적인 작업 단위로 나뉘어 실행**된다.
    - 결과적으로, **코드의 이해가 쉬워지고, 유지보수가 용이**해진다.
2. **성능 및 처리량 향상**
    - **웹 애플리케이션, 서버, 대량 데이터 처리** 같은 프로그램에서는 동시성이 필수적이다.
    - 예를 들어, 웹 요청을 처리하는 서블릿(Servlet)은 각 요청을 개별 스레드에서 실행하여 효율성을 높인다.
    - 만약 데이터 수집기가 단일 스레드로 실행된다면, 한 사이트의 데이터를 가져오는 동안 대기해야 하므로 전체 처리 시간이 길어진다.
    - 여러 개의 스레드가 동시에 데이터를 가져오도록 하면, **수집 속도를 크게 향상**시킬 수 있다.
3. **실제 응용 사례**
    - **웹 서버**: 여러 사용자의 요청을 동시에 처리해야 함.
    - **정보 수집기**: 다수의 웹사이트에서 데이터를 수집하는 경우 성능 향상 가능.
    - **데이터 분석 시스템**: 대량의 데이터를 병렬로 처리하여 분석 속도를 높임.

---

## 2️⃣ **동시성이 어려운 이유 & 흔한 오해**

### **동시성에 대한 오해**

1. **"동시성이 항상 성능을 향상시킨다."**
    
    → ❌ 잘못된 생각이다. **멀티 스레드는 오히려 성능을 저하시킬 수도 있다.**
    
    - 여러 개의 스레드가 하나의 자원을 공유하면 **스레드 간 동기화로 인해 성능이 낮아질 수 있음**.
    - 단순한 작업에서는 동시성이 필요하지 않을 수도 있다.
2. **"동시성을 구현해도 설계는 변하지 않는다."**
    
    → ❌ 단일 스레드와 다중 스레드 프로그램은 **설계 방식이 완전히 다르다.**
    
    - 동시성을 적용하면, 데이터의 공유 방식과 실행 흐름을 고려해야 하므로 설계가 크게 변경됨.
3. **"웹 컨테이너(EJB, 서블릿)를 사용하면 동시성을 이해할 필요가 없다."**
    
    → ❌ 서블릿 컨테이너가 동시성을 관리하지만, **개발자가 직접 동시 수정(Concurrency Issue)과 데드락(Deadlock) 문제를 해결해야 한다.**
    
    - 예를 들어, **동일한 변수를 여러 스레드가 동시에 수정하면 예상치 못한 결과가 발생**할 수 있다.

### ⚠️ **동시성의 어려움**

1. **코드 복잡성 증가**
    - 단일 스레드 코드에 비해 **디버깅과 테스트가 훨씬 어려움**.
    - 예상하지 못한 타이밍 이슈(Concurrency Bug)가 발생할 가능성이 높음.
2. **디버깅이 어려움**
    - 다중 스레드에서 발생하는 오류는 재현하기 어려운 경우가 많음.
    - 특정 조건에서만 발생하는 "일회성 오류"가 흔함.
3. **동기화 문제**
    - 여러 스레드가 동시에 데이터를 수정하면, **데이터 무결성이 깨질 위험이 있음**.
    - 예제:
        
        ```java
        public class X {
            private int lastIdUsed;
            public int getNextId() {
                return ++lastIdUsed;
            }
        }
        ```
        
    - 위 코드를 다중 스레드에서 실행하면 **같은 ID가 여러 번 할당되거나, ID가 중복되는 문제가 발생**할 수 있다.

---

## 3️⃣ **깨끗한 동시성 코드를 위한 원칙**

### **1. 단일 책임 원칙 (SRP) 적용**

- `동시성 관련 코드를 일반적인 코드와 분리해야 한다.`
- **"동시성 코드 자체가 변경될 이유가 하나여야 한다."**
- 동시성 코드는 **별도의 개발, 변경, 조율 주기를 가진다**.

### **2. 공유 데이터 최소화**

- **공유 데이터가 많을수록, 동기화가 필요하고 동시성 오류 가능성이 높아짐**.
- 데이터를 공유해야 한다면, **임계영역(`Critical Section`)을 최소화**하고, **동기화 기법(`Synchronized, Lock` 등)을 적용**해야 한다.
- 자원을 캡슐화 해라. 공유 자료를 최대한 줄여라.

### **3. 스레드 독립성 유지**

- 공유 자료를 줄이려면 처음부터 공유하지 않는 방법이 제일 좋음.
- **가능하면 스레드 간 데이터를 공유하지 않도록 설계**.
- 공유 데이터를 줄이기 위해 "복사본을 사용"할 수도 있다.

### **4. 동시성 지원 라이브러리 활용**

- 자바에서는 `java.util.concurrent` 패키지를 활용하여 동시성을 쉽게 관리할 수 있음.
- `ConcurrentHashMap`, `Semaphore`, `CountDownLatch` 등 활용 가능.

### **5. 동기화 최소화**

- `synchronized`를 남발하면 성능이 저하될 수 있으므로 최소화해야 함.
- 필요한 곳에만 락을 걸고, 가능한 락을 짧게 유지하는 것이 중요하다.

---

## 4️⃣ **동시성 코드 테스트 방법**

### **1. 동시성 테스트 기본 원칙**

- **"일회성 문제라고 생각되는 버그는 반드시 동시성 문제를 의심하라!"**
- 순차적으로 실행되는 코드가 완벽하게 동작하는지 먼저 확인한 후, 동시성을 추가해야 한다.
- 다양한 환경(멀티코어, 다른 OS)에서 테스트해야 한다.

### **2. 다양한 테스트 기법**

1. **스레드 개수를 다르게 설정해서 테스트**
2. **다른 플랫폼(OS)에서 실행 테스트**
3. **"흔들기(Jiggling) 기법" 적용**
    - `Thread.sleep()`이나 `Thread.yield()`를 랜덤하게 추가하여 실행 순서를 변화시키고, 오류가 나타나게 유도한다.
    - 예제:
        
        ```java
        public synchronized String nextUrlOrNull() {
            if(hasNext()) {
                Thread.yield(); // 테스트를 위해 추가된 코드
                String url = urlGenerator.next();
                return url;
            }
            return null;
        }
        ```
        
4. **자동화 테스트 도구 사용**
    - IBM의 `ConTest` 같은 도구를 활용하면, **스레드 실행 순서를 바꿔가며 테스트**할 수 있다.

---

## 5️⃣ **결론: 깨끗한 동시성 코드 작성 방법**

1. **SRP(단일 책임 원칙)를 준수하여 동시성 코드를 분리**한다.
2. **공유 데이터를 최소화**하고, 가능한 독립적인 스레드로 구현한다.
3. **자바의 동시성 라이브러리를 활용하여 코드의 안정성을 높인다**.
4. **동기화(Synchronized, Lock) 구역을 최소화**하여 성능 저하를 방지한다.
5. **테스트 자동화를 도입하고, 다양한 환경에서 실행하여 동시성 버그를 조기에 발견한다**.

---

### **요약**

*"동시성 코드는 복잡하지만, SRP 원칙을 지키고, 공유 데이터를 최소화하며, 철저히 테스트하면 깨끗하고 안정적인 동시성 코드를 만들 수 있다."*
